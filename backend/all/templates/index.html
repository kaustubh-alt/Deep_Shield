<!DOCTYPE html>
<html>
  <head>
    <title>Deep Shield - Image Processing</title>
    <style>
      .container {
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
      }
      .preview {
        max-width: 300px;
        margin: 20px 0;
      }
      #responseContainer {
        margin-top: 20px;
        padding: 10px;
        border: 1px solid #ccc;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h2>Deep Shield Image Analysis</h2>
      <form id="uploadForm">
        {% csrf_token %}
        <input type="file" id="imageInput" accept="image/*" required />
        <button type="submit">Analyze Image</button>
      </form>
      <img id="preview" class="preview" style="display: none" />
      <div id="responseContainer"></div>
    </div>

    <script>
      // Get CSRF token
      function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
          const cookies = document.cookie.split(";");
          for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === name + "=") {
              cookieValue = decodeURIComponent(
                cookie.substring(name.length + 1)
              );
              break;
            }
          }
        }
        return cookieValue;
      }

      // Preview image before upload
      document
        .getElementById("imageInput")
        .addEventListener("change", function (e) {
          const preview = document.getElementById("preview");
          preview.src = URL.createObjectURL(e.target.files[0]);
          preview.style.display = "block";
        });

      // Handle form submission
      document
        .getElementById("uploadForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          const imageInput = document.getElementById("imageInput");
          const responseContainer =
            document.getElementById("responseContainer");
          const csrftoken = getCookie("csrftoken");

          if (!imageInput.files[0]) {
            responseContainer.innerHTML =
              '<p style="color: red;">Please select an image to upload.</p>';
            return;
          }

          // Convert image to base64
          const reader = new FileReader();
          reader.onload = async function () {
            try {
              const response = await fetch("/api/process-image", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({
                  image: reader.result,
                }),
              });

              const result = await response.json();

              if (response.ok) {
                responseContainer.innerHTML = `
                            <h3 style="color: green;">Analysis Complete</h3>
                            <p><strong>Prediction:</strong> ${result.prediction}</p>
                            <p><strong>Confidence:</strong> ${result.confidence}%</p>
                        `;
              } else {
                responseContainer.innerHTML = `
                            <h3 style="color: red;">Error</h3>
                            <p>${result.error || "Unknown error occurred"}</p>
                        `;
              }
            } catch (error) {
              responseContainer.innerHTML = `
                        <h3 style="color: red;">Error</h3>
                        <p>Failed to process image. Please try again.</p>
                    `;
              console.error("Error:", error);
            }
          };
          reader.readAsDataURL(imageInput.files[0]);
        });
    </script>
  </body>
</html>
